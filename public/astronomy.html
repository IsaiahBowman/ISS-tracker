<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Google Maps ISS testing</title>

    <link rel='stylesheet' href='/stylesheets/astronomy.css' />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  </head>
  <body>
    <div id="map"></div>
    <div id="InfoPane">
        <div class="your-location">
            Your Location:<br>
            <div class="lat-label">Latitude: <p class="your-lat"></p></div>
            <div class="lng-label">Longitude: <p class="your-lng"></p></div>
        </div>
        <br>
        <div class="iss-location">
            ISS Location:<br>
            <div class="lat-label">Latitude: <p class="iss-lat"></p></div>
            <div class="lng-label">Longitude: <p class="iss-lng"></p></div>
            <br>
            Location Details:<br>
            <div class="country-label">Country: <p></p></div>
            <div class="area_1-label">State/Region: <p></p></div>
            <div class="area_2-label">City: <p></p></div>
            <div class="establishment-label">Ocean/Establishment: <p></p></div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDH_crf80-s8-jMeVEzRCLcUNJysmyhzvU&callback=initMap"
    async defer></script>

    <script>
      var map;
      var geolocationKey = "AIzaSyDH_crf80-s8-jMeVEzRCLcUNJysmyhzvU";
      var geoCodeKey = "AIzaSyDH_crf80-s8-jMeVEzRCLcUNJysmyhzvU";

      var issPath = [];
      var userLocation = false;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 5,
          draggable: false
        });
        var icon = {
          url: "/images/iss-icon-map-overlay.png", // url
          scaledSize: new google.maps.Size(50, 50), // scaled size
          origin: new google.maps.Point(0,0), // origin
          anchor: new google.maps.Point(25, 25) // anchor
        };

        var marker = new google.maps.Marker({
                icon: icon,
                map: map,
                position: new google.maps.LatLng(-34.397, 150.644)
            });
        var pathTrack;

        
        setISS(marker);
        var startTrack = setInterval(function() {
          setISS(marker);
        }, 3000);

        navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            $('.your-location .your-lat').text(pos.lat);
            $('.your-location .your-lng').text(pos.lng);
            // infoWindow.setPosition(pos);
            // infoWindow.setContent('Location found.');
            // infoWindow.open(map);
            // map.setCenter(pos);
            $.get(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${pos.lat},${pos.lng}&key=${geolocationKey}
`, function(data) {
                console.log(data);
            });
        });

      }

      function setISS(marker) {
        var getData = getIssData();
          getData.done(function(data, status, xhr) {
            
            var currLat = data.iss_position.latitude,
                currLng = data.iss_position.longitude;

            var center = new google.maps.LatLng(currLat, currLng);
            var currentPosition = {
              lat: parseFloat(currLat),
              lng: parseFloat(currLng)
            };

            marker.setPosition(new google.maps.LatLng(currLat, currLng));

            if(!userLocation) {
                console.log(map.data);
                $.get(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${currLat},${currLng}&key=${geolocationKey}
`, function(data) {
                console.log(data);
                userLocation = true;
            });
            }

            

            issPath.push(currentPosition);

            map.panTo(center);
            pathTrack = new google.maps.Polyline({
              path: issPath,
              geodesic: true,
              strokeColor: '#FF0000',
              strokeOpacity: 1.0,
              strokeWeight: 2
            });

            pathTrack.setMap(map);

            $.get(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${currentPosition.lat},${currentPosition.lng}&key=${geolocationKey}`, function(data) {
                // setLocationName(parseLocationObj(data));
                updateInfoPane(currentPosition, parseLocationObj(data));
            });
           
            // pathTrack.setPath(issPath);
          });
          getData.fail(function(err) {
            console.log(err);
          });
      }

      function setLocationName(pLocObj) {
        // console.log(pLocObj);
        // $.each(pLocObj, function(i, item) {
        //   console.log(i);
        //   console.log(item);
        //   console.log('');
        // });
      }

      function parseLocationObj(locObj) {
        var newLocObj = {
          country: 'N/A',
          administrative_area_level_1: 'N/A',
          administrative_area_level_2: 'N/A',
          establishment: 'N/A'
        };
        if(locObj.status === "ZERO_RESULTS") {
          newLoc = {
            location: 'No associated location. Middle of nowhere.'
          };
          return newLocObj;
        }

        $.each(locObj.results[0].address_components, function(i, item) {
          switch(item.types[0]) {
            case 'establishment': 
              newLocObj.establishment = item.long_name;
              break;
            case 'country': 
              newLocObj.country = item.long_name;
              break;
            case 'administrative_area_level_1': 
              newLocObj.administrative_area_level_1 = item.long_name;
              break;
            case 'administrative_area_level_2': 
              newLocObj.administrative_area_level_2 = item.long_name;
              break;
          }
        });
        
        return newLocObj;
      }

      function updateInfoPane(location, locationDetails) {
        $('.iss-location .iss-lat').text(location.lat);
        $('.iss-location .iss-lng').text(location.lng);

        console.log(locationDetails);
        $('.iss-location .establishment-label > p').text(locationDetails.establishment);
        $('.iss-location .country-label > p').text(locationDetails.country);
        $('.iss-location .area_1-label > p').text(locationDetails.administrative_area_level_1);
        $('.iss-location .area_2-label > p').text(locationDetails.administrative_area_level_2);
      }

      function getIssData() {
        return $.ajax('http://api.open-notify.org/iss-now.json');
      }

    </script>
  </body>
</html>
